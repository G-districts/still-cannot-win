<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teacher ¬∑ G School</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">

<style>
  :root{
    --bg:#f6f8fb; --panel:#ffffff; --ink:#0b1b34; --muted:#667085; --brand:#0b57d0;
    --border:#e6e9ef; --shadow:0 4px 14px rgba(0,0,0,.06);
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);}

  /* ----- App shell ----- */
  .app{display:grid;grid-template-columns:240px 1fr;min-height:100%}
  .sidebar{
    background:#101828; color:#e6edf7; padding:16px 12px; display:flex; flex-direction:column; gap:8px;
  }
  .nav-title{font-weight:800; letter-spacing:.4px; display:flex; align-items:center; gap:8px}
  .nav-group{margin-top:12px; display:flex; flex-direction:column; gap:4px}
  .nav-btn{
    display:flex; gap:10px; align-items:center; padding:10px 12px; border-radius:8px; cursor:pointer;
    color:#e6edf7; text-decoration:none;
  }
  .nav-btn:hover{background:rgba(255,255,255,.06)}
  .nav-btn.active{background:#1d2939}

  .main{padding:16px 18px 36px}
  .topbar{
    background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
    display:flex; align-items:center; gap:10px; padding:10px 12px; margin-bottom:12px;
  }
  .push{margin-left:auto}
  .btn{
    background:var(--brand)!important; color:#fff!important; border:none; border-radius:8px; padding:8px 10px;
    font-weight:600; cursor:pointer;
  }
  .btn.secondary{ background:#eef2f7!important; color:#0b1b34!important; border:1px solid var(--border) }
  .toggle{display:flex; align-items:center; gap:8px}

  /* ----- Tabs row (Screens/Timelines/Screenshots/Call Students) ----- */
  .subtabs{display:flex; gap:8px; margin:10px 0 14px}
  .chip{padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer}
  .chip.active{border-color:var(--brand); color:var(--brand); font-weight:700}

  /* ----- Student grid ----- */
  .grid{
    display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:12px;
  }
  .card{
    background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
    padding:10px; display:flex; flex-direction:column; gap:8px;
  }
  .card.online{border-color:#bfd1ff}
  .card.offline{border-color:#e6e9ef; opacity:.92}
  .shot{width:100%; height:160px; object-fit:cover; border-radius:8px; border:1px solid #e6e6e6; background:#fafafa; cursor:pointer}
  .row{display:flex; align-items:center; gap:8px}
  .mini{font-size:12px; color:var(--muted)}
  .pill{font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); background:#f7f9fe}

  /* ----- Scenes board (left Allowed / right Blocked) ----- */
  .scenes-board{
    display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:16px;
  }
  .panel{
    background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
    padding:14px; display:flex; flex-direction:column; gap:10px;
  }
  .panel h4{margin:0}
  .scene-list{display:flex; flex-direction:column; gap:8px}
  .scene-item{
    border:1px solid var(--border); border-radius:10px; padding:10px; background:#fff; display:flex; align-items:center; gap:8px;
  }
  .scene-title{font-weight:700}
  .menu{margin-left:auto; display:flex; gap:6px}
  .menu .btn{padding:6px 8px}
  .muted{color:var(--muted); font-size:13px}

  /* ----- Dropdown (Apply a Scene) ----- */
  .scene-chooser{position:relative}
  .scene-dd{
    position:absolute; right:0; top:100%; margin-top:6px; background:#fff; border:1px solid var(--border);
    border-radius:10px; box-shadow:var(--shadow); min-width:280px; display:none; z-index:10;
  }
  .scene-dd.open{display:block}
  .scene-dd .group{padding:8px 8px 6px; border-bottom:1px solid var(--border)}
  .scene-dd .group:last-child{border-bottom:none}
  .scene-dd .rowbtn{display:flex; align-items:center; gap:10px; padding:8px; border-radius:8px; cursor:pointer}
  .scene-dd .rowbtn:hover{background:#f3f6fb}
  .badge{display:inline-block; width:10px; height:10px; border-radius:2px}
  .badge.allow{background:#2ba97a}
  .badge.block{background:#d92d20}

  /* ----- Dialogs ----- */
  dialog::backdrop{background:rgba(0,0,0,.32)}
  dialog{border:none; border-radius:12px; width:min(860px,96vw)}
  .tabslist{display:flex; flex-direction:column; gap:8px; max-height:260px; overflow:auto}
  .tabrow{display:flex; gap:8px; align-items:center; font-size:12px}
  .tabrow img{width:14px; height:14px}
  .tabrow button{margin-left:auto}

  /* ----- Raise-hand toasts ----- */
  .raise-toast{position:relative; background:#fff; border:1px solid var(--border); border-radius:10px; padding:8px 10px; box-shadow:0 6px 16px rgba(0,0,0,.12); margin-bottom:8px; min-width:260px}
  .raise-toast .meta{font-size:12px; color:#555}
  #raiseTray{position:fixed; right:16px; top:16px; z-index:99999; display:flex; flex-direction:column; align-items:flex-end}

  /* Overlay spinner */
  #overlay{display:none; position:fixed; inset:0; background:rgba(255,255,255,.6); z-index:99998; justify-content:center; align-items:center}
  #overlay .spin{border:4px solid #eee; border-top:4px solid var(--brand); border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ===== Student Monitor ===== */
  #monitorDlg { width:clamp(1100px, 98vw, 2200px); max-height:98vh; padding:0; }
  .monitor-shell{
    display:grid;
    grid-template-columns:3fr 240px; /* way bigger screen, slimmer chat */
    gap:0;
    height:min(96vh,1000px);
  }
  .monitor-title{font-weight:700}
  .monitor-actions{margin-left:auto; display:flex; gap:8px}
  .monitor-actions .btn{padding:6px 10px}
  .browser{display:flex; flex-direction:column; gap:0; background:#f4f6fb; border-top:1px solid var(--border); height:100%;}
  .tabstrip{display:flex; gap:6px; padding:8px; overflow:auto; background:#eef3ff; border-bottom:1px solid var(--border);}
  .tabchip{display:flex; flex-direction:column; gap:6px; background:#fff; border:1px solid var(--border); border-radius:10px; padding:6px 8px; cursor:pointer; max-width:240px; min-width:160px;}
  .tabchip.active{border-color:#0b57d0; box-shadow:0 0 0 1px #0b57d0 inset}
  .tabhead{display:flex; align-items:center; gap:8px}
  .tabhead img{width:16px; height:16px}
  .tabhead .title{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:180px}
  .tabhead .close{margin-left:4px; font-weight:700; color:#888; cursor:pointer}
  .tabhead .close:hover{color:#333}
  .tabthumb{width:100%; height:48px; object-fit:cover; border:1px solid #e5e8f0; border-radius:8px; background:#fff}
  .monitor-canvas{flex:1; display:flex; align-items:center; justify-content:center; background:#0b1b3410; padding:8px}
  .monitor-canvas img{width:100%; height:100%; object-fit:contain; border-radius:10px; background:#000}

  /* thumbnails bar under each student card */
  .thumbbar{display:flex; gap:6px; padding-top:6px; overflow:hidden}
  .thumbbar img{width:22px; height:22px; border-radius:4px; border:1px solid #e5e8f0; background:#fff}
  .card .status{display:flex; justify-content:space-between; align-items:center}

  /* DM pane */
  .dm-pane{ border-left:1px solid var(--border); background:#fff; display:flex; flex-direction:column;}
  .dm-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border); background:#f7f9fc; font-weight:700;}
  .dm-thread{flex:1; overflow:auto; padding:12px}
  .dm-msg{margin:6px 0; max-width:88%}
  .dm-me{margin-left:auto; text-align:right}
  .dm-bubble{display:inline-block; padding:8px 10px; border-radius:10px; background:#eef3ff; border:1px solid var(--border);}
  .dm-me .dm-bubble{ background:#dbeafe; }
  .dm-meta{font-size:11px; color:#667085; margin-top:2px}
  .dm-compose{display:flex; gap:8px; padding:10px; border-top:1px solid var(--border);}
  .dm-compose textarea{flex:1; resize:vertical; min-height:42px}
</style>
</head>
<body>
<div class="app">
  <!-- ========== Sidebar ========== -->
  <aside class="sidebar">
    <div class="nav-title">üìò <span>Teacher</span></div>
    <div class="nav-group">
      <a class="nav-btn active" id="navClassrooms">üè´ Classrooms</a>
      <a class="nav-btn" id="navScenes">üß© Scenes</a>
      <a class="nav-btn" id="navCalendar">üìÖ Calendar</a>
      <a class="nav-btn" id="navReports">üìä Student Reports</a>
      <a class="nav-btn" id="navHelp">‚ùì Help</a>
    </div>
  </aside>

  <!-- ========== Main ========== -->
  <main class="main">
    <!-- Top session toolbar -->
    <div class="topbar">
      <strong id="classTitle">G district</strong>
      <span class="muted">¬∑ <span id="updateTime">‚Äî</span></span>

      <div class="push"></div>
      <div class="scene-chooser">
        <button class="btn secondary" id="sceneToggle">
          <span id="sceneCurrent">No scene applied</span> ‚ñæ
        </button>
        <!-- Dropdown -->
        <div class="scene-dd" id="sceneDropdown">
          <div class="group">
            <div class="rowbtn" data-dd="disable-scene">üö´ <span>Disable Scene</span></div>
            <div class="rowbtn" data-dd="create-scene">‚ûï <span>Create New Scene</span></div>
          </div>
          <div class="group" id="ddAllowed">
            <div class="muted" style="padding:4px 6px;">Enable Allowed Websites List</div>
          </div>
          <div class="group" id="ddBlocked">
            <div class="muted" style="padding:4px 6px;">Enable Blocked Websites List</div>
          </div>
        </div>
      </div>

      <button class="btn" id="focusBtn">Focus</button>
      <button class="btn" id="pauseBtn">Lock</button>
      <button class="btn" id="announceBtn">Announcement</button>
      <button class="btn" id="notifyBtn">Notify</button>
      <button class="btn" id="openTabsBtn">Open Tabs</button>
      <button class="btn" id="examBtn">Exam Mode</button>
      <button class="btn" id="pollBtn">Poll</button>
    </div>

    <!-- Subtabs -->
    <div class="subtabs">
      <div class="chip active">Screens</div>
      <div class="chip">Timelines</div>
      <div class="chip">Screenshots</div>
      <div class="chip">Call Students</div>
      <div class="chip toggle"><input id="chatEnabled" type="checkbox" checked /> Chat</div>
      <button class="btn" id="applyChat">Apply Chat Settings</button>
      <div class="chip toggle"><input id="offTask" type="checkbox" /> Off-Task Alerts</div>
    </div>

    <div class="card" id="offtaskCard">
      <h3>‚ö†Ô∏è Off-Task Alerts</h3>
      <div id="offtaskList">No alerts.</div>
    </div>

    <!-- üîπ NEW: Engagement Dashboard -->
    <section class="card" id="engagement-card" style="margin-top: 1rem;">
      <h2>Engagement Dashboard</h2>
      <label for="engagement-window">
        Time window:
        <select id="engagement-window">
          <option value="900">Last 15 minutes</option>
          <option value="1800" selected>Last 30 minutes</option>
          <option value="3600">Last 60 minutes</option>
        </select>
      </label>
      <div class="table-wrapper" style="max-height: 320px; overflow-y: auto; margin-top: .5rem;">
        <table id="engagement-table" class="table">
          <thead>
            <tr>
              <th>Student</th>
              <th>Engagement</th>
              <th>Off-task</th>
              <th>Alerts</th>
              <th>Tabs</th>
              <th>Risk</th>
            </tr>
          </thead>
          <tbody><!-- filled by JS --></tbody>
        </table>
      </div>
    </section>
    <!-- /Engagement Dashboard -->

    <!-- Views toolbar -->
    <div class="toolbar" id="subtabs" style="gap:8px">
      <span><b>Views</b></span>
      <button class="btn" data-tab="screens">Screens</button>
      <button class="btn" data-tab="timeline">Timeline</button>
      <button class="btn" data-tab="shots">Screenshots</button>
      <button class="btn" data-tab="attention">Attention</button>
      <button class="btn" data-tab="scenesShare">Scenes</button>
      <span style="margin-left:auto"></span>
      <label class="mini" style="display:flex;align-items:center;gap:6px">
        <input id="offTaskToggle" type="checkbox"> Off-Task Alerts
      </label>
      <button class="btn" id="offTaskApply">Apply</button>
    </div>

    <section id="panels" style="margin-top:8px">
      <div id="panel-screens"></div>

      <div id="panel-timeline" class="card" style="display:none">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select id="tlStudent"></select>
          <button class="btn" id="tlRefresh">Refresh</button>
        </div>
        <div id="tlList" class="tabslist" style="margin-top:8px"></div>
      </div>

      <div id="panel-shots" class="card" style="display:none">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select id="shStudent"></select>
          <button class="btn" id="shRefresh">Refresh</button>
        </div>
        <div id="shGrid" class="grid" style="margin-top:8px"></div>
      </div>

      <div id="panel-attention" class="card" style="display:none">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn" id="attStart">Start Check</button>
          <button class="btn" id="attView">View Results</button>
        </div>
        <div id="attResults" class="tabslist" style="margin-top:8px"></div>
      </div>

      <div id="panel-scenesShare" class="card" style="display:none">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="scnId" placeholder="Scene ID (optional)" style="flex:1 1 220px">
          <button class="btn" id="scnExportOne">Export One</button>
          <button class="btn" id="scnExportAll">Export All</button>
          <input type="file" id="scnImportFile" accept="application/json" style="display:none">
          <button class="btn" id="scnImportBtn">Import JSON‚Ä¶</button>
        </div>
        <pre id="scnOut" style="white-space:pre-wrap;margin-top:8px;max-height:280px;overflow:auto"></pre>
      </div>
    </section>

    <!-- Quick toggles -->
    <div class="topbar" style="gap:18px">
      <div class="toggle"><input id="active" type="checkbox" checked /> Active</div>
      <div class="toggle"><input id="focus" type="checkbox" /> Focus (allow-only)</div>
      <div class="toggle"><input id="paused" type="checkbox" /> Lock Internet</div>
      <button class="btn" id="saveClass">Apply</button>
      <div class="push"></div>
      <button class="btn secondary" id="excludeBtn">Exclude from session</button>
      <button class="btn secondary" id="presentBtn">Present</button>
    </div>

    <!-- YouTube Filtering -->
    <section class="toolbar" style="flex-direction:column;align-items:stretch;gap:12px">
      <h4>YouTube Filtering</h4>
      <label>Blocked Keywords<textarea id="ytBlockKeywords" rows="3" placeholder="minecraft&#10;mrbeast"></textarea></label>
      <label>Blocked Channels<textarea id="ytBlockChannels" rows="3" placeholder="PewDiePie&#10;DanTDM"></textarea></label>
      <label><input type="checkbox" id="ytAllowMode"> Allow-Only Mode</label>
      <label>Allowed Channels / Keywords<textarea id="ytAllowList" rows="3" placeholder="Khan Academy&#10;National Geographic"></textarea></label>
      <button class="btn" id="saveYouTubeRules">Save YouTube Rules</button>
    </section>

    <!-- Student grid -->
    <section style="display:flex;gap:16px;align-items:flex-start">
      <div style="flex:3">
        <div class="grid" id="screenGrid"></div>
      </div>
      <div id="dmPane" class="dm-pane" style="flex:1;display:none;max-height:520px;">
        <div class="dm-head">
          <span id="dmTitle">Direct message</span>
        </div>
        <div id="dmThread" class="dm-thread"></div>
        <div class="dm-compose">
          <textarea id="dmInput" placeholder="Type a message to this student‚Ä¶"></textarea>
          <button class="btn" id="dmSend">Send</button>
        </div>
      </div>
    </section>

    <!-- Google Doodles -->
    <section class="toolbar">
      <h4>Google Doodles</h4>
      <label><input type="checkbox" id="toggleDoodles"> Block Google Doodles</label>
      <button class="btn" id="saveDoodles">Apply</button>
    </section>

    <!-- Scenes board -->
    <section id="scenesSection" style="display:none">
      <div class="scenes-board">
        <div class="panel" id="allowedPanel">
          <h4>Allowed Websites List</h4>
          <p class="muted">Students can <b>only</b> access websites you allowed; everything else is blocked.</p>
          <div>
            <button class="btn" id="createAllowed">Create List</button>
            <select id="allowedSort" class="mini" style="margin-left:8px">
              <option value="recent">Sort by: Recently Used</option>
              <option value="name">Sort by: Name</option>
            </select>
          </div>
          <div class="scene-list" id="allowedList"></div>
        </div>

        <div class="panel" id="blockedPanel">
          <h4>Blocked Websites List</h4>
          <p class="muted">Students can browse any website, except what you blocked.</p>
          <div>
            <button class="btn" id="createBlocked">Create List</button>
            <select id="blockedSort" class="mini" style="margin-left:8px">
              <option value="recent">Sort by: Recently Used</option>
              <option value="name">Sort by: Name</option>
            </select>
          </div>
          <div class="scene-list" id="blockedList"></div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- raise-hand tray + overlay -->
<div id="raiseTray"></div>
<div id="overlay"><div class="spin"></div></div>

<!-- ========= Dialogs ========= -->
<!-- (unchanged dialogs omitted for brevity; this is your file as provided)‚Äîall dialogs are still present here -->

<!-- ... dialogs content stays the same ... -->

<script>
/* -----------------------------------------------------------
   Utilities
----------------------------------------------------------- */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const overlay = $('#overlay');
const raiseTray = $('#raiseTray');
function showOverlay(){ overlay.style.display='flex'; }
function hideOverlay(){ overlay.style.display='none'; }
function toast(msg, ms=2500){
  const div=document.createElement('div');
  div.className='raise-toast';
  div.innerHTML='<b>'+msg+'</b>';
  raiseTray.appendChild(div);
  setTimeout(()=>div.remove(), ms);
}
function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

/* -----------------------------------------------------------
   Persistent cache (per-student, per-tab screenshots)
----------------------------------------------------------- */
const CACHE_KEY = 'studentCache_v1';
let studentCache = {};
try{ studentCache = JSON.parse(localStorage.getItem(CACHE_KEY)||'{}'); }catch(_){ studentCache={}; }
function persistCache(){ try{ localStorage.setItem(CACHE_KEY, JSON.stringify(studentCache)); }catch(_){ } }
function setStudentCache(id, patch){
  studentCache[id] = Object.assign({tabshots:{}}, studentCache[id]||{}, patch||{});
  persistCache();
}
function setTabShot(id, tabId, data){
  const s = studentCache[id] || {tabshots:{}};
  s.tabshots = s.tabshots || {};
  s.tabshots[String(tabId)] = data;
  s.lastActive = Date.now();
  studentCache[id] = s;
  persistCache();
}
function deleteTabShot(id, tabId){
  if(studentCache[id] && studentCache[id].tabshots){
    delete studentCache[id].tabshots[String(tabId)];
    persistCache();
  }
}

/* -----------------------------------------------------------
   Global UI state
----------------------------------------------------------- */
const state = {
  scenes: {allowed:[], blocked:[], current:null},
  presence: {}
};

/* -----------------------------------------------------------
   Load initial class data
----------------------------------------------------------- */
async function loadData(){
  const j = await (await fetch('/api/data')).json();
  $('#focus').checked  = j.classes.period1.focus_mode;
  $('#paused').checked = j.classes.period1.paused;
  $('#chatEnabled').checked = j.settings.chat_enabled;
  $('#active').checked = j.classes.period1.active;
  $('#classTitle').textContent = j.classes.period1.name || 'MEGACLASS';
  $('#updateTime').textContent = 'Update Time';
}
loadData();

/* -----------------------------------------------------------
   üîπ Engagement Dashboard (NEW)
----------------------------------------------------------- */
async function refreshEngagement() {
  const sel = document.getElementById("engagement-window");
  if (!sel) return;
  const windowSec = sel.value || 1800;

  let resp;
  try {
    resp = await fetch(`/api/engagement?window=${windowSec}`);
  } catch (e) {
    console.warn("engagement fetch failed", e);
    return;
  }
  if (!resp.ok) {
    console.warn("engagement HTTP error", resp.status);
    return;
  }

  const data = await resp.json();
  if (!data.ok) return;

  const tbody = document.querySelector("#engagement-table tbody");
  if (!tbody) return;
  tbody.innerHTML = "";

  const students = data.students || [];

  // Sort by risk, then by name
  students.sort((a, b) => {
    const riskOrder = { high: 0, medium: 1, low: 2 };
    const ra = riskOrder[a.risk] ?? 3;
    const rb = riskOrder[b.risk] ?? 3;
    if (ra !== rb) return ra - rb;
    return (a.student || "").localeCompare(b.student || "");
  });

  for (const s of students) {
    const tr = document.createElement("tr");

    const pct = Math.round((s.engagement || 0) * 100);
    let riskEmoji = "‚úÖ";
    if (s.risk === "medium") riskEmoji = "‚ö†Ô∏è";
    if (s.risk === "high") riskEmoji = "üö®";

    tr.innerHTML = `
      <td>${s.student || ""}</td>
      <td>${pct}%</td>
      <td>${s.offtask_events ?? 0}</td>
      <td>${s.alerts ?? 0}</td>
      <td>${s.tabs_open ?? 0}</td>
      <td>${riskEmoji}</td>
    `;

    tbody.appendChild(tr);
  }
}
document.addEventListener("DOMContentLoaded", () => {
  const sel = document.getElementById("engagement-window");
  if (sel) sel.addEventListener("change", refreshEngagement);
  refreshEngagement();
  setInterval(refreshEngagement, 15000);
});

/* -----------------------------------------------------------
   Presence + Smart Screenshot Persistence
   (unchanged below)
----------------------------------------------------------- */
async function refreshPresence(){
  const res = await fetch('/api/presence'); if(!res.ok) return;
  const pres = await res.json(); state.presence = pres;

  const now = Date.now();

  // merge live presence into cache
  Object.entries(pres).forEach(([student, info])=>{
    const existing = studentCache[student] || {tabshots:{}};
    const tabs = info.tabs || [];
    const openIds = new Set(tabs.map(t=> String(t.id)));

    const lastActive = now;
    const newShot = info.screenshot || existing.screenshot || '';
    const mergedShots = Object.assign({}, existing.tabshots);

    const incomingTabshots = info.tabshots || {};
    for (const [tid, shot] of Object.entries(incomingTabshots)){
      const t = tabs.find(x => String(x.id)===String(tid)) || {};
      const dataUrl = typeof shot === 'string' ? shot : (shot && shot.dataUrl) || '';
      mergedShots[String(tid)] = {
        dataUrl,
        title: t.title || t.url || '',
        favIconUrl: t.favIconUrl || ''
      };
    }

    for (const tid of Object.keys(mergedShots)){
      if(!openIds.has(String(tid))) delete mergedShots[tid];
    }

    setStudentCache(student, {
      screenshot: newShot,
      lastActive,
      offline: false,
      tabshots: mergedShots
    });
  });

  // Mark offline/inactive students
  for(const [student, cache] of Object.entries(studentCache)){
    const seen = pres.hasOwnProperty(student);
    const inactive = (now - (cache.lastActive||0)) > 5*60*1000;
    if(!seen || inactive){
      setStudentCache(student, {offline:true});
    }
  }

  // Render grid
  const grid = $('#screenGrid'); grid.innerHTML='';
  const allIds = Array.from(new Set([...Object.keys(studentCache), ...Object.keys(pres)])).sort();

  allIds.forEach(student=>{
    const info = pres[student] || {};
    const cache = studentCache[student] || {};
    const isOffline = !!cache.offline;

    const card=document.createElement('div'); 
    card.className='card ' + (isOffline ? 'offline' : 'online');

    const shot=document.createElement('img'); 
    shot.className='shot'; 
    const src = (!isOffline && info.screenshot) ? info.screenshot : (cache.screenshot||'');
    if(src) shot.src = src;
    shot.alt = student + ' screen';
    shot.onclick = ()=> openMonitor(student);
    card.appendChild(shot);

    const r1=document.createElement('div'); 
    r1.className='status';
    r1.innerHTML = `
      <div class="row">
        <b>${escapeHtml(student)}</b>
        <span class="pill mini">${escapeHtml((info.tab && info.tab.title) || (isOffline?'Waiting for student activity‚Ä¶':'') )}</span>
      </div>
      <span class="mini">${isOffline ? ('Last active ' + timeAgo(cache.lastActive||0)) : 'Online'}</span>
    `;
    card.appendChild(r1);

    const bar = document.createElement('div'); 
    bar.className='thumbbar';
    const tabs = (info.tabs||[]).slice(0,8);
    tabs.forEach(t=>{
      const img=document.createElement('img');
      const ts = cache.tabshots && cache.tabshots[String(t.id)];
      const thumb = (typeof ts === 'string') ? ts : (ts && ts.dataUrl);
      img.src = thumb || (t.favIconUrl || '');
      img.title = t.title || t.url || '';
      bar.appendChild(img);
    });
    if(isOffline && cache.tabshots){
      const extra = Object.entries(cache.tabshots).slice(0,8);
      extra.forEach(([_, meta])=>{
        const img=document.createElement('img');
        const thumb = (typeof meta === 'string') ? meta : (meta && meta.dataUrl);
        img.src = thumb || '';
        img.title = (typeof meta === 'object' && meta && meta.title) ? meta.title : '';
        bar.appendChild(img);
      });
    }
    card.appendChild(bar);

    const actions=document.createElement('div'); 
    actions.className='row'; actions.style.justifyContent='flex-end'; actions.style.gap='6px';

    const dmBtn=document.createElement('button'); 
    dmBtn.className='btn secondary'; 
    dmBtn.textContent='DM';
    dmBtn.onclick=()=> openDmForStudent(student, info && info.name ? info.name : student);

    const perStu=document.createElement('button'); 
    perStu.className='btn secondary'; 
    perStu.textContent='Controls';
    perStu.onclick=()=>{ $('#perStudentDlg').showModal(); $('#studentSelect').value=student; };

    const view=document.createElement('button'); 
    view.className='btn'; 
    view.textContent='View';
    view.onclick=()=> openMonitor(student);

    actions.appendChild(dmBtn);
    actions.appendChild(perStu); 
    actions.appendChild(view);
    card.appendChild(actions);

    grid.appendChild(card);
  });
}
function timeAgo(ts){
  if(!ts) return 'a while ago';
  const s = Math.max(1, Math.floor((Date.now()-ts)/1000));
  if(s<60) return s+'s ago';
  const m = Math.floor(s/60); if(m<60) return m+'m ago';
  const h = Math.floor(m/60); return h+'h ago';
}
refreshPresence(); setInterval(refreshPresence, 8000);

/* === YouTube Rules (unchanged) === */
document.getElementById('saveYouTubeRules').onclick = async ()=>{
  const blockKeywords = document.getElementById('ytBlockKeywords').value.split('\n').map(s=>s.trim()).filter(Boolean);
  const blockChannels = document.getElementById('ytBlockChannels').value.split('\n').map(s=>s.trim()).filter(Boolean);
  const allow = document.getElementById('ytAllowList').value.split('\n').map(s=>s.trim()).filter(Boolean);
  const allowMode = document.getElementById('ytAllowMode').checked;
  await fetch('/api/youtube_rules',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({block_keywords:blockKeywords,block_channels:blockChannels,allow:allow,allow_mode:allowMode})});
  alert('YouTube rules updated');
};
async function loadYouTubeRules(){
  const res=await fetch('/api/youtube_rules');
  if(!res.ok) return;
  const r=await res.json();
  document.getElementById('ytBlockKeywords').value=(r.block_keywords||[]).join('\n');
  document.getElementById('ytBlockChannels').value=(r.block_channels||[]).join('\n');
  document.getElementById('ytAllowList').value=(r.allow||[]).join('\n');
  document.getElementById('ytAllowMode').checked=!!r.allow_mode;
}
loadYouTubeRules();

/* -----------------------------------------------------------
   (All other existing JS below remains as in your file)
   Student modal, session buttons, DM, monitor, scenes, etc.
----------------------------------------------------------- */

/* ... the rest of your script content from your file continues here unchanged ... */
</script>

<!-- Your existing second/third <script> blocks continue unchanged ‚Ä¶ -->

<div style="position:fixed;right:16px;bottom:16px;background:#0b57d0;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.2);font-weight:600">
  <a href="/teacher/present" style="color:#fff;text-decoration:none">üñ•Ô∏è Teacher Presentation</a>
</div>


<script>
document.addEventListener("DOMContentLoaded", () => {
  // ---- Scene apply / disable hooked to existing HTML ----
  async function applyScene(sceneId) {
    if (!sceneId) return;
    if (window.showOverlay) window.showOverlay();
    try {
      const res = await fetch("/api/scenes/apply", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: sceneId })
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok || j.ok === false) {
        throw new Error(j.error || "Failed to apply scene");
      }
      if (window.toast) toast("Scene applied");
    } catch (e) {
      console.error("applyScene", e);
      alert("Failed to apply scene");
    } finally {
      if (window.hideOverlay) window.hideOverlay();
      if (typeof window.loadScenes === "function") window.loadScenes();
    }
  }

  async function disableScene() {
    const dd = document.getElementById("sceneDropdown");
    if (dd && dd.classList) dd.classList.remove("open");
    if (window.showOverlay) window.showOverlay();
    try {
      const res = await fetch("/api/scenes/clear", { method: "POST" });
      const j = await res.json().catch(() => ({}));
      if (!res.ok || j.ok === false) {
        throw new Error(j.error || "Failed to disable scene");
      }
      if (window.toast) toast("Scene disabled");
    } catch (e) {
      console.error("disableScene", e);
      alert("Failed to disable scene");
    } finally {
      if (window.hideOverlay) window.hideOverlay();
      if (typeof window.loadScenes === "function") window.loadScenes();
    }
  }

  window.applyScene = applyScene;
  window.disableScene = disableScene;

  // ---- Direct Messages (teacher <-> single student) ----
  let dmCurrentStudent = null;

  const dmPane    = document.getElementById("dmPane");
  const dmTitleEl = document.getElementById("dmTitle");
  const dmThreadEl= document.getElementById("dmThread");
  const dmInputEl = document.getElementById("dmInput");
  const dmSendBtn = document.getElementById("dmSend");

  async function loadDmThread() {
    if (!dmCurrentStudent || !dmThreadEl) return;
    try {
      const res = await fetch("/api/dm/me?student=" + encodeURIComponent(dmCurrentStudent));
      if (!res.ok) return;
      const msgs = await res.json();
      dmThreadEl.innerHTML = "";
      for (const m of msgs) {
        const isMe = m.from === "teacher";
        const wrap = document.createElement("div");
        wrap.className = "dm-msg" + (isMe ? " dm-me" : "");

        const bubble = document.createElement("div");
        bubble.className = "dm-bubble";
        bubble.textContent = m.text || "";
        wrap.appendChild(bubble);

        const meta = document.createElement("div");
        meta.className = "dm-meta";
        const who = isMe ? "You" : (m.user || "Student");
        const when = m.ts ? new Date(m.ts * 1000).toLocaleTimeString() : "";
        meta.textContent = who + (when ? " ‚Ä¢ " + when : "");
        wrap.appendChild(meta);

        dmThreadEl.appendChild(wrap);
      }
      dmThreadEl.scrollTop = dmThreadEl.scrollHeight;
    } catch (e) {
      console.error("loadDmThread", e);
    }
  }

  async function sendDm() {
    if (!dmCurrentStudent || !dmInputEl) return;
    const text = dmInputEl.value.trim();
    if (!text) return;
    dmInputEl.value = "";
    try {
      const res = await fetch("/api/dm/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ student: dmCurrentStudent, text })
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok || j.ok === false) throw new Error(j.error || "send failed");
      await loadDmThread();
    } catch (e) {
      console.error("sendDm", e);
      alert("Failed to send message");
    }
  }

  window.openDmForStudent = function(email, name) {
    dmCurrentStudent = email;
    if (dmTitleEl) dmTitleEl.textContent = name || email;
    if (dmPane) dmPane.style.display = "flex";
    loadDmThread();
  };

  if (dmSendBtn) dmSendBtn.addEventListener("click", sendDm);
  if (dmInputEl) {
    dmInputEl.addEventListener("keydown", (ev) => {
      if (ev.key === "Enter" && !ev.shiftKey) {
        ev.preventDefault();
        sendDm();
      }
    });
  }

  // Poll current thread for new messages
  setInterval(loadDmThread, 5000);
});
</script>
</body>
</html>
