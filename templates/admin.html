<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin · G School</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    body { max-width:1200px; margin:auto; padding:1rem }
    body, label, h3, h4, .mini, button, .btn { color:#000 !important; }
    table { width:100%; border-collapse:collapse; margin-top:10px }
    th, td { border:1px solid #ccc; padding:6px; text-align:left }
    td input[type="url"] { width:100% }
  </style>
</head>
<body>
<nav>
  <ul><li><strong>Admin</strong></li></ul>
  <ul><li><a href="/teacher">Teacher</a></li><li><a href="/logout">Logout</a></li></ul>
</nav>

<h3>Settings</h3>
<article>
  <label>Default Blocked Redirect URL 
    <input id="blocked" type="url" value="{{ data.settings.blocked_redirect }}">
  </label>
  <label><input id="chat" type="checkbox" {{ 'checked' if data.settings.chat_enabled else '' }}> Enable Chat</label>
  <label>Extension Passcode <input id="passcode" type="password" placeholder="admin1234"></label>
  <button id="save">Save</button>
  <small id="msg" style="margin-left:8px"></small>
</article>

<h3>Categories (AI-powered)</h3>
<article>
  <table>
    <thead>
      <tr><th>Category</th><th>Blocked?</th><th>Block Page</th><th>Save</th></tr>
    </thead>
    <tbody id="cats"></tbody>
  </table>
</article>

<h4>Category Schedules (auto block/unblock)</h4>
<article>
  <p class="mini">
    Use schedules to automatically turn category blocking <b>on</b> and <b>off</b> at specific times.
    When a schedule is enabled for a category, it overrides the manual “Blocked?” toggle.
  </p>
  <div style="display:flex; flex-wrap:wrap; gap:1rem; align-items:flex-end">
    <label>
      Category
      <select id="schedCategory"></select>
    </label>
    <label>
      <input type="checkbox" id="schedEnabled">
      Enable schedule for this category
    </label>
    <label>
      Start time
      <input type="time" id="schedStart">
    </label>
    <label>
      End time
      <input type="time" id="schedEnd">
    </label>
    <label>
      <input type="checkbox" id="schedWeekdays">
      Weekdays only (Mon–Fri)
    </label>
    <button id="saveSchedule" class="secondary">Save Schedule</button>
    <small id="schedMsg" style="margin-left:6px"></small>
  </div>
</article>

<h3>Manual Overrides</h3>
<article>
  <details open>
    <summary>Manage Global Allow/Block Lists</summary>
    <label>Always Allow (one URL per line)
      <textarea id="allowlist" rows="5"></textarea>
    </label>
    <label>Always Block (one URL per line)
      <textarea id="blocklist" rows="5"></textarea>
    </label>
    <button id="saveLists">Save Overrides</button>
    <small id="msg2" style="margin-left:8px"></small>
  </details>
</article>

<!-- NEW: User management -->
<h3>Users</h3>
<article>
  <details open>
    <summary>Admin &amp; Teacher Accounts</summary>
    <p class="mini">
      Create and manage sign-in accounts for the teacher and admin dashboards.
      These accounts <b>do not</b> affect student extension logins.
    </p>
    <div style="display:flex; flex-wrap:wrap; gap:1rem; align-items:flex-end">
      <label>
        Email
        <input type="email" id="userEmail" placeholder="teacher@example.com">
      </label>
      <label>
        Password
        <input type="password" id="userPassword" placeholder="Set or reset password">
      </label>
      <label>
        Role
        <select id="userRole">
          <option value="teacher">Teacher</option>
          <option value="admin">Admin</option>
        </select>
      </label>
      <button id="saveUser">Save User</button>
      <small id="userMsg" style="margin-left:8px"></small>
    </div>

    <table>
      <thead>
        <tr><th>Email</th><th>Role</th><th>Actions</th></tr>
      </thead>
      <tbody id="usersBody"></tbody>
    </table>
  </details>
</article>

<script>
// Load categories + overrides
let _latestCategories = [];

function updateScheduleForm() {
  const cats = _latestCategories || [];
  const sel = document.getElementById('schedCategory');
  if (!sel) return;

  let selectedName = sel.value;
  if (!selectedName && cats.length) {
    selectedName = cats[0].name;
    sel.value = selectedName;
  }

  const cat = cats.find(c => c.name === selectedName) || {};
  const sched = cat.schedule || null;

  const enabledEl = document.getElementById('schedEnabled');
  const startEl = document.getElementById('schedStart');
  const endEl = document.getElementById('schedEnd');
  const weekdaysEl = document.getElementById('schedWeekdays');
  if (!enabledEl || !startEl || !endEl || !weekdaysEl) return;

  enabledEl.checked = !!(sched && sched.enabled);
  startEl.value = (sched && sched.start) || "";
  endEl.value = (sched && sched.end) || "";
  weekdaysEl.checked = !!(sched && sched.weekdays_only);
}

async function refresh(){
  // categories from AI API
  const res = await fetch('/api/ai/categories');
  const j = await res.json();
  const cats = j.categories || [];
  _latestCategories = cats;

  const tbody = document.getElementById('cats');
  tbody.innerHTML = '';
  cats.forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><b>${c.name}</b></td>
      <td><input type="checkbox" ${c.blocked ? 'checked' : ''} data-name="${c.name}" class="blk"></td>
      <td><input type="url" value="${c.block_url || ''}" data-name="${c.name}" class="bp"></td>
      <td><button data-name="${c.name}" class="saveCat">Save</button></td>
    `;
    tbody.appendChild(tr);
  });

  // Populate schedule category dropdown
  const sel = document.getElementById('schedCategory');
  if (sel) {
    const prev = sel.value;
    sel.innerHTML = '';
    cats.forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c.name;
      opt.textContent = c.name;
      sel.appendChild(opt);
    });
    if (prev && cats.some(c=>c.name===prev)) {
      sel.value = prev;
    }
    updateScheduleForm();
  }

  // ✅ load global overrides
  const o = await (await fetch('/api/overrides')).json();
  document.getElementById('allowlist').value = (o.allowlist || []).join("\n");
  document.getElementById('blocklist').value = (o.teacher_blocks || []).join("\n");

  // ✅ load users
  await loadUsers();
}
refresh();

// Save global settings
document.getElementById('save').onclick = async()=>{
  const body = {
    blocked_redirect: document.getElementById('blocked').value,
    chat_enabled: document.getElementById('chat').checked,
    passcode: document.getElementById('passcode').value
  };
  const r = await fetch('/api/settings',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  document.getElementById('msg').textContent = r.ok?'Saved':'Error';
  setTimeout(()=>document.getElementById('msg').textContent='',1500);
};

// Save individual category
document.addEventListener('click', async(e)=>{
  if(e.target.classList.contains('saveCat')){
    const name = e.target.dataset.name;
    const blocked = document.querySelector('.blk[data-name="'+name+'"]').checked;
    const block_url = document.querySelector('.bp[data-name="'+name+'"]').value;
    const body = {name, blocked, block_url};
    const r = await fetch('/api/ai/categories',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    alert(r.ok ? 'Saved!' : 'Error saving category');
    refresh();
  }
});

// Save schedule for selected category
const schedCategoryEl = document.getElementById('schedCategory');
const saveScheduleBtn = document.getElementById('saveSchedule');
if (schedCategoryEl && saveScheduleBtn) {
  schedCategoryEl.addEventListener('change', updateScheduleForm);
  saveScheduleBtn.onclick = async()=>{
    const name = schedCategoryEl.value;
    if (!name) return;
    const schedule = {
      enabled: document.getElementById('schedEnabled').checked,
      start: document.getElementById('schedStart').value || null,
      end: document.getElementById('schedEnd').value || null,
      weekdays_only: document.getElementById('schedWeekdays').checked
    };
    const body = { name, schedule };
    const r = await fetch('/api/ai/categories',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    const msgEl = document.getElementById('schedMsg');
    if (msgEl) {
      msgEl.textContent = r.ok ? 'Schedule saved' : 'Error saving schedule';
      setTimeout(()=>{ msgEl.textContent=''; }, 2000);
    }
    if (r.ok) {
      refresh();
    }
  };
}

// Save manual overrides
document.getElementById('saveLists').onclick = async()=>{
  const allowlist = document.getElementById('allowlist').value
    .split("\n").map(s=>s.trim()).filter(Boolean);
  const teacher_blocks = document.getElementById('blocklist').value
    .split("\n").map(s=>s.trim()).filter(Boolean);
  const body = {allowlist, teacher_blocks};
  const r = await fetch('/api/overrides',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  document.getElementById('msg2').textContent = r.ok?'Saved':'Error';
  setTimeout(()=>document.getElementById('msg2').textContent='',1500);
};

// -----------------------------
// User management (Admin/Teacher)
// -----------------------------
async function loadUsers(){
  const tbody = document.getElementById('usersBody');
  if (!tbody) return;
  try {
    const res = await fetch('/api/users');
    if (!res.ok) {
      tbody.innerHTML = '<tr><td colspan="3">Unable to load users</td></tr>';
      return;
    }
    const j = await res.json();
    const users = j.users || [];
    tbody.innerHTML = '';
    if (!users.length) {
      tbody.innerHTML = '<tr><td colspan="3">No users yet. Create one above.</td></tr>';
      return;
    }
    users.forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.email}</td>
        <td>
          <select data-email="${u.email}" class="userRoleSelect">
            <option value="teacher" ${u.role==='teacher'?'selected':''}>Teacher</option>
            <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
          </select>
        </td>
        <td>
          <button class="userSave" data-email="${u.email}">Save</button>
          <button class="userDelete secondary" data-email="${u.email}">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (e) {
    console.error('loadUsers error', e);
    tbody.innerHTML = '<tr><td colspan="3">Error loading users</td></tr>';
  }
}

// Create / update user from form
const saveUserBtn = document.getElementById('saveUser');
if (saveUserBtn) {
  saveUserBtn.onclick = async()=>{
    const emailEl = document.getElementById('userEmail');
    const pwEl = document.getElementById('userPassword');
    const roleEl = document.getElementById('userRole');
    const msgEl = document.getElementById('userMsg');
    const email = (emailEl.value || '').trim().toLowerCase();
    const password = pwEl.value || '';
    const role = roleEl.value || 'teacher';

    if (!email || !password) {
      msgEl.textContent = 'Email and password are required';
      setTimeout(()=>msgEl.textContent='', 2000);
      return;
    }

    const body = { email, password, role };
    const r = await fetch('/api/users',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    msgEl.textContent = r.ok ? 'Saved' : 'Error saving user';
    setTimeout(()=>msgEl.textContent='', 2000);
    if (r.ok) {
      pwEl.value = '';
      await loadUsers();
    }
  };
}

// Row-level actions: change role / delete
document.addEventListener('click', async(e)=>{
  if (e.target.classList.contains('userSave')) {
    const email = e.target.dataset.email;
    const sel = document.querySelector('select.userRoleSelect[data-email="'+email+'"]');
    if (!sel) return;
    const role = sel.value || 'teacher';
    const body = { email, role };
    const r = await fetch('/api/users',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if (!r.ok) {
      alert('Error saving user');
    }
  }
  if (e.target.classList.contains('userDelete')) {
    const email = e.target.dataset.email;
    if (!confirm('Delete user '+email+'? This cannot be undone.')) return;
    const r = await fetch('/api/users/delete',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email })
    });
    if (!r.ok) {
      alert('Error deleting user');
      return;
    }
    await loadUsers();
  }
});
</script>
</body>
</html>
